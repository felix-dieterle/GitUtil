name: Package Mobile Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: '8.2'
      
      - name: Extract version from tag
        id: extract_version
        run: |
          if [[ "${GITHUB_REF}" =~ ^refs/tags/v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            major="${BASH_REMATCH[1]}"
            minor="${BASH_REMATCH[2]}"
            patch="${BASH_REMATCH[3]}"
            version="${major}.${minor}.${patch}"
            # Calculate version code: major*10000 + minor*100 + patch
            version_code=$((major * 10000 + minor * 100 + patch))
            echo "version=${version}" >> $GITHUB_OUTPUT
            echo "version_code=${version_code}" >> $GITHUB_OUTPUT
          else
            version="dev-$(date +%Y%m%d-%H%M%S)"
            # Use a shorter format for dev builds to avoid overflow
            # Format: (year-2020)*1000000 + month*10000 + day*100 + hour
            year=$(date +%Y)
            month=$(date +%m)
            day=$(date +%d)
            hour=$(date +%H)
            # Force decimal interpretation with 10# prefix to avoid octal interpretation of zero-padded values
            version_code=$(( (10#$year - 2020) * 1000000 + 10#$month * 10000 + 10#$day * 100 + 10#$hour ))
            echo "version=${version}" >> $GITHUB_OUTPUT
            echo "version_code=${version_code}" >> $GITHUB_OUTPUT
          fi
      
      - name: Update version in build.gradle
        run: |
          cd android/app
          # Use gradle properties instead of sed for more robust version injection
          echo "ext.versionNameOverride=\"${{ steps.extract_version.outputs.version }}\"" >> build.gradle
          echo "ext.versionCodeOverride=${{ steps.extract_version.outputs.version_code }}" >> build.gradle
      
      - name: Grant execute permission for gradlew
        run: chmod +x android/gradlew
      
      - name: Build and Sign APK
        env:
          # If production signing secrets are available, use them; otherwise fallback to debug keystore
          KEYSTORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          SIGNING_KEY_BASE64: ${{ secrets.SIGNING_KEY }}
        run: |
          cd android
          # If production keystore is provided, create it in a secure temporary location
          if [ -n "$SIGNING_KEY_BASE64" ]; then
            # Create temporary directory with restricted permissions
            TEMP_DIR=$(mktemp -d)
            trap "rm -rf $TEMP_DIR" EXIT
            echo "$SIGNING_KEY_BASE64" | base64 -d > "$TEMP_DIR/release.keystore"
            export KEYSTORE_FILE="$TEMP_DIR/release.keystore"
          else
            # Generate a debug keystore if production keys are not available
            mkdir -p "$HOME/.android"
            if [ ! -f "$HOME/.android/debug.keystore" ]; then
              keytool -genkeypair -v \
                -keystore "$HOME/.android/debug.keystore" \
                -alias androiddebugkey \
                -keyalg RSA \
                -keysize 2048 \
                -validity 10000 \
                -storepass android \
                -keypass android \
                -dname "CN=Android Debug,O=Android,C=US"
            fi
          fi
          ./gradlew assembleRelease --no-daemon --stacktrace
      
      - name: Rename APK
        run: |
          cd android/app/build/outputs/apk/release
          mv app-release.apk gitutil-mobile-${{ steps.extract_version.outputs.version }}.apk
      
      - name: Generate APK checksum
        run: |
          cd android/app/build/outputs/apk/release
          sha256sum gitutil-mobile-*.apk > apk-checksum.txt
          cat apk-checksum.txt
      
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: |
            android/app/build/outputs/apk/release/gitutil-mobile-*.apk
            android/app/build/outputs/apk/release/apk-checksum.txt
          retention-days: 90
      
      - name: Create tag for dev builds
        if: "!startsWith(github.ref, 'refs/tags/')"
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.extract_version.outputs.version }}" -m "Development build ${{ steps.extract_version.outputs.version }}"
          git push origin "${{ steps.extract_version.outputs.version }}" || echo "Tag already exists or push failed, continuing..."
      
      - name: Create or update GitHub Release with APK
        if: startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || steps.extract_version.outputs.version }}
          name: ${{ startsWith(github.ref, 'refs/tags/') && format('Release {0}', steps.extract_version.outputs.version) || format('Development Build {0}', steps.extract_version.outputs.version) }}
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
          files: |
            android/app/build/outputs/apk/release/gitutil-mobile-*.apk
            android/app/build/outputs/apk/release/apk-checksum.txt
          body: |
            ## GitUtil Mobile APK - ${{ steps.extract_version.outputs.version }}
            
            ### ðŸ“± Android Installation Package
            
            This APK provides a standalone GitUtil app for Android with built-in git support.
            
            **Features:**
            - Built-in git operations using JGit
            - Touch-optimized interface
            - Clone repositories from URLs
            - Repository browser
            - No external dependencies required
            - Beautiful Material Design interface
            
            **Installation:**
            1. Download `gitutil-mobile-${{ steps.extract_version.outputs.version }}.apk`
            2. Enable installation from unknown sources:
               - **Android 8.0+**: Settings â†’ Apps â†’ Special app access â†’ Install unknown apps â†’ [Your Browser] â†’ Allow
               - **Android 7.x**: Settings â†’ Security â†’ Unknown Sources
            3. Open the APK file to install
            4. Launch the app and tap "ðŸš€ Launch GitUtil"
            5. Grant storage permission when prompted
            
            **Requirements:**
            - Android 7.0 (API 24) or higher
            - About 10 MB of storage space
            - That's it! No external dependencies needed
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
