<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>GitUtil Mobile</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
--ink-900:#0d1821;--ink-700:#344055;--ink-500:#5f6c7b;--ink-300:#9199a1;
--sky-600:#1b6ca8;--sky-500:#2e8bc0;--sky-400:#89c2d9;
--grass-600:#2d6a4f;--grass-500:#40916c;
--fire-600:#d62828;--fire-500:#f77f00;
--pearl-100:#f1faee;--pearl-50:#ffffff;
--gap:8px;--curve:12px;--press-zone:54px
}
body{
font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;
background:var(--pearl-100);color:var(--ink-900);line-height:1.5;font-size:16px
}
.widget-shell{max-width:750px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column}
.masthead{
background:linear-gradient(135deg,var(--sky-600),var(--sky-500));
color:var(--pearl-50);padding:calc(var(--gap)*2.5);box-shadow:0 2px 10px rgba(0,0,0,0.15);
position:sticky;top:0;z-index:100
}
.masthead h1{font-size:24px;font-weight:700;letter-spacing:-0.5px}
.masthead p{font-size:13px;opacity:0.9;margin-top:4px}
.canvas{flex:1;padding:calc(var(--gap)*2)}
.card{
background:var(--pearl-50);border-radius:var(--curve);
padding:calc(var(--gap)*2.5);margin-bottom:calc(var(--gap)*2);
box-shadow:0 1px 4px rgba(0,0,0,0.08)
}
.card__header{font-size:19px;font-weight:650;margin-bottom:calc(var(--gap)*2);color:var(--sky-600)}
.input-zone{margin-bottom:calc(var(--gap)*2.5)}
.input-zone__label{display:block;font-size:14px;font-weight:550;margin-bottom:var(--gap);color:var(--ink-700)}
.text-box{
width:100%;padding:calc(var(--gap)*1.75) calc(var(--gap)*2);font-size:16px;
border:2px solid var(--ink-300);border-radius:calc(var(--curve)*0.7);
background:var(--pearl-50);transition:border-color 0.2s;font-family:inherit
}
.text-box:focus{outline:none;border-color:var(--sky-400)}
.action-btn{
width:100%;min-height:var(--press-zone);padding:calc(var(--gap)*2) calc(var(--gap)*3);
font-size:17px;font-weight:600;border:none;border-radius:calc(var(--curve)*0.7);
cursor:pointer;transition:transform 0.1s,opacity 0.2s;display:flex;align-items:center;
justify-content:center;gap:var(--gap);box-shadow:0 2px 6px rgba(0,0,0,0.1);font-family:inherit
}
.action-btn:active{transform:scale(0.96)}
.btn-primary{background:var(--sky-500);color:var(--pearl-50)}
.btn-success{background:var(--grass-500);color:var(--pearl-50)}
.btn-danger{background:var(--fire-600);color:var(--pearl-50)}
.btn-neutral{background:var(--pearl-50);color:var(--ink-900);border:2px solid var(--ink-300)}
.btn-secondary{background:var(--ink-300);color:var(--pearl-50)}
.btn-locked{opacity:0.4;pointer-events:none}
.timeline-zone{max-height:56vh;overflow-y:auto;-webkit-overflow-scrolling:touch;margin-bottom:calc(var(--gap)*2)}
.repo-list-zone{max-height:50vh;overflow-y:auto;-webkit-overflow-scrolling:touch;margin-bottom:calc(var(--gap)*2)}
.repo-card{
background:var(--pearl-100);border:2px solid var(--ink-300);
border-radius:calc(var(--curve)*0.8);padding:calc(var(--gap)*2);
margin-bottom:calc(var(--gap)*1.5);cursor:pointer;transition:all 0.15s;position:relative
}
.repo-card:active{background:#dde5ed;border-color:var(--sky-500)}
.repo-card__name{font-size:16px;font-weight:600;margin-bottom:4px;color:var(--ink-900)}
.repo-card__path{font-size:12px;color:var(--ink-500);font-family:'Courier New',monospace}
.snapshot-card{
background:var(--pearl-100);border:2px solid var(--ink-300);
border-radius:calc(var(--curve)*0.8);padding:calc(var(--gap)*2);
margin-bottom:calc(var(--gap)*1.5);cursor:pointer;transition:all 0.15s;position:relative
}
.snapshot-card:active{background:#dde5ed;border-color:var(--sky-500)}
.snapshot-card.active-pick{border-color:var(--sky-600);background:#d4e7f5}
.snapshot-card__hash{
font-family:'Courier New',monospace;font-size:13px;
color:var(--ink-500);margin-bottom:calc(var(--gap)*0.5)
}
.snapshot-card__msg{font-size:15px;font-weight:400;margin-bottom:var(--gap);line-height:1.3}
.snapshot-card__meta{display:flex;gap:calc(var(--gap)*1.5);flex-wrap:wrap;font-size:13px;color:var(--ink-500)}
.meta-piece{display:inline-flex;align-items:center;gap:4px}
.notice-bar{
padding:calc(var(--gap)*1.75) calc(var(--gap)*2);border-radius:calc(var(--curve)*0.7);
margin-bottom:calc(var(--gap)*2);font-size:14px;line-height:1.4
}
.notice-info{background:#cfe2ff;color:#084298;border-left:4px solid var(--sky-500)}
.notice-good{background:#d1e7dd;color:#0f5132;border-left:4px solid var(--grass-600)}
.notice-bad{background:#f8d7da;color:#842029;border-left:4px solid var(--fire-600)}
.notice-alert{background:#fff3cd;color:#664d03;border-left:4px solid var(--fire-500)}
.spin-wheel{
display:inline-block;width:18px;height:18px;border:3px solid rgba(255,255,255,0.3);
border-top-color:var(--pearl-50);border-radius:50%;animation:rotate-spin 0.8s linear infinite
}
@keyframes rotate-spin{to{transform:rotate(360deg)}}
.screen-off{display:none}
.btn-row{display:flex;gap:calc(var(--gap)*1.5);margin-top:calc(var(--gap)*2)}
.btn-row .action-btn{flex:1}
.void-box{text-align:center;padding:calc(var(--gap)*5) calc(var(--gap)*2.5);color:var(--ink-500)}
.void-box__icon{font-size:48px;margin-bottom:calc(var(--gap)*1.5);opacity:0.4}
.link-btn{
background:none;border:none;color:var(--sky-600);text-decoration:underline;
padding:0;margin-top:calc(var(--gap)*1.5);cursor:pointer;font-size:14px;font-family:inherit
}
.link-btn:active{opacity:0.7}
.log-error{color:#d62828}
.log-warn{color:#f77f00}
.log-info{color:#2e8bc0}
</style>
</head>
<body>
<div class="widget-shell">
<header class="masthead">
<h1>GitUtil Mobile</h1>
<p>Git commit browser and rollback tool</p>
</header>
<main class="canvas">
<!-- Repository Selector View -->
<div id="repoSelector" class="view-mode">
<div class="card">
<h2 class="card__header">Select Repository</h2>
<div id="workspaceInfo" class="notice-bar notice-info"></div>
<div id="repoList" class="repo-list-zone"></div>
<div class="btn-row">
<button id="githubBtn" class="action-btn btn-primary">üåê Browse GitHub</button>
<button id="cloneBtn" class="action-btn btn-success">üì¶ Clone URL</button>
</div>
<div class="btn-row">
<button id="browseBtn" class="action-btn btn-neutral">üìÇ Custom Path</button>
</div>
</div>
<div id="repoMsg"></div>
</div>

<!-- GitHub Authentication View -->
<div id="githubAuthView" class="view-mode screen-off">
<div class="card">
<h2 class="card__header">GitHub Authentication</h2>
<div class="notice-bar notice-info">
Enter your GitHub Personal Access Token to browse and clone your repositories.
<br><br>
<strong>How to get a token:</strong><br>
1. Go to GitHub Settings ‚Üí Developer settings ‚Üí Personal access tokens<br>
2. Generate new token (classic)<br>
3. Select 'repo' scope<br>
4. Copy the token
</div>
<div class="input-zone">
<label class="input-zone__label">GitHub Token</label>
<input type="password" id="githubTokenBox" class="text-box" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
</div>
<div class="btn-row">
<button id="githubAuthBtn" class="action-btn btn-primary">Connect to GitHub</button>
<button id="githubAuthCancelBtn" class="action-btn btn-neutral">Cancel</button>
</div>
</div>
<div id="githubAuthMsg"></div>
</div>

<!-- GitHub Repository Browser View -->
<div id="githubBrowserView" class="view-mode screen-off">
<div class="card">
<h2 class="card__header">GitHub Repositories</h2>
<div id="githubRepoList" class="repo-list-zone"></div>
<div class="btn-row">
<button id="githubBackBtn" class="action-btn btn-neutral">Back</button>
</div>
</div>
<div id="githubBrowserMsg"></div>
</div>

<!-- Clone Repository View -->
<div id="cloneView" class="view-mode screen-off">
<div class="card">
<h2 class="card__header">Clone Repository</h2>
<div class="input-zone">
<label class="input-zone__label">Repository URL</label>
<input type="text" id="cloneUrlBox" class="text-box" placeholder="https://github.com/user/repo.git">
</div>
<div class="input-zone">
<label class="input-zone__label">Repository Name (optional)</label>
<input type="text" id="cloneNameBox" class="text-box" placeholder="Leave empty to auto-detect">
</div>
<div class="btn-row">
<button id="cloneConfirmBtn" class="action-btn btn-success">Clone</button>
<button id="cloneCancelBtn" class="action-btn btn-neutral">Cancel</button>
</div>
</div>
<div id="cloneMsg"></div>
</div>

<!-- Custom Path View -->
<div id="customPathView" class="view-mode screen-off">
<div class="card">
<h2 class="card__header">Custom Repository Path</h2>
<div class="input-zone">
<label class="input-zone__label">Full Path</label>
<input type="text" id="locationBox" class="text-box" placeholder="/sdcard/git/my-project">
</div>
<div class="btn-row">
<button id="verifyBtn" class="action-btn btn-primary">Verify Location</button>
<button id="customCancelBtn" class="action-btn btn-neutral">Cancel</button>
</div>
</div>
<div id="locationMsg"></div>
</div>

<!-- Timeline Viewer -->
<div id="timelineViewer" class="view-mode screen-off">
<div class="card">
<h2 class="card__header">Timeline Browser</h2>
<div id="pathDisplay" class="notice-bar notice-info"></div>
<div id="snapshotList" class="timeline-zone"></div>
<div class="btn-row">
<button id="rollbackBtn" class="action-btn btn-danger btn-locked">Apply Rollback</button>
<button id="switchBtn" class="action-btn btn-neutral">Change Repo</button>
</div>
<div class="btn-row">
<button id="viewLogsBtn" class="action-btn btn-secondary">üìã View Logs</button>
</div>
</div>
<div id="rollbackMsg"></div>
</div>

<!-- Log Viewer -->
<div id="logViewer" class="view-mode screen-off">
<div class="card">
<h2 class="card__header">Application Logs</h2>
<div class="notice-bar notice-info">
Recent console logs from the application
</div>
<div id="logContent" class="timeline-zone" style="font-family: 'Courier New', monospace; font-size: 12px; white-space: pre-wrap; word-break: break-all;"></div>
<div class="btn-row">
<button id="refreshLogsBtn" class="action-btn btn-primary">üîÑ Refresh</button>
<button id="clearLogsBtn" class="action-btn btn-neutral">üóëÔ∏è Clear</button>
<button id="closeLogsBtn" class="action-btn btn-neutral">Back</button>
</div>
</div>
</div>
</main>
</div>
<script>
const AppLogs=[];
const maxLogEntries=500;
const originalConsole={
log:console.log,
error:console.error,
warn:console.warn,
info:console.info
};
// Override console methods to capture logs
console.log=function(...args){
const msg='[LOG] '+args.join(' ');
AppLogs.push({time:new Date().toISOString(),msg:msg,type:'log'});
if(AppLogs.length>maxLogEntries)AppLogs.shift();
originalConsole.log.apply(console,args);
};
console.error=function(...args){
const msg='[ERROR] '+args.join(' ');
AppLogs.push({time:new Date().toISOString(),msg:msg,type:'error'});
if(AppLogs.length>maxLogEntries)AppLogs.shift();
originalConsole.error.apply(console,args);
};
console.warn=function(...args){
const msg='[WARN] '+args.join(' ');
AppLogs.push({time:new Date().toISOString(),msg:msg,type:'warn'});
if(AppLogs.length>maxLogEntries)AppLogs.shift();
originalConsole.warn.apply(console,args);
};
console.info=function(...args){
const msg='[INFO] '+args.join(' ');
AppLogs.push({time:new Date().toISOString(),msg:msg,type:'info'});
if(AppLogs.length>maxLogEntries)AppLogs.shift();
originalConsole.info.apply(console,args);
};

const WidgetState={loc:'',snapshots:[],picked:null,workspace:'',repos:[],githubToken:'',githubRepos:[],lastView:null};
const Nodes={
// Repo selector
repoSelector:document.getElementById('repoSelector'),
workspaceInfo:document.getElementById('workspaceInfo'),
repoList:document.getElementById('repoList'),
githubBtn:document.getElementById('githubBtn'),
cloneBtn:document.getElementById('cloneBtn'),
browseBtn:document.getElementById('browseBtn'),
repoMsg:document.getElementById('repoMsg'),
// GitHub auth view
githubAuthView:document.getElementById('githubAuthView'),
githubTokenBox:document.getElementById('githubTokenBox'),
githubAuthBtn:document.getElementById('githubAuthBtn'),
githubAuthCancelBtn:document.getElementById('githubAuthCancelBtn'),
githubAuthMsg:document.getElementById('githubAuthMsg'),
// GitHub browser view
githubBrowserView:document.getElementById('githubBrowserView'),
githubRepoList:document.getElementById('githubRepoList'),
githubBackBtn:document.getElementById('githubBackBtn'),
githubBrowserMsg:document.getElementById('githubBrowserMsg'),
// Clone view
cloneView:document.getElementById('cloneView'),
cloneUrlBox:document.getElementById('cloneUrlBox'),
cloneNameBox:document.getElementById('cloneNameBox'),
cloneConfirmBtn:document.getElementById('cloneConfirmBtn'),
cloneCancelBtn:document.getElementById('cloneCancelBtn'),
cloneMsg:document.getElementById('cloneMsg'),
// Custom path view
customPathView:document.getElementById('customPathView'),
locationBox:document.getElementById('locationBox'),
verifyBtn:document.getElementById('verifyBtn'),
customCancelBtn:document.getElementById('customCancelBtn'),
locationMsg:document.getElementById('locationMsg'),
// Timeline viewer
timelineViewer:document.getElementById('timelineViewer'),
pathDisplay:document.getElementById('pathDisplay'),
snapshotList:document.getElementById('snapshotList'),
rollbackBtn:document.getElementById('rollbackBtn'),
switchBtn:document.getElementById('switchBtn'),
rollbackMsg:document.getElementById('rollbackMsg'),
viewLogsBtn:document.getElementById('viewLogsBtn'),
// Log viewer
logViewer:document.getElementById('logViewer'),
logContent:document.getElementById('logContent'),
refreshLogsBtn:document.getElementById('refreshLogsBtn'),
clearLogsBtn:document.getElementById('clearLogsBtn'),
closeLogsBtn:document.getElementById('closeLogsBtn')
};

const escapeHtml=(text)=>{
const div=document.createElement('div');
div.textContent=text;
return div.innerHTML;
};

const showMsg=(target,txt,kind)=>{
target.innerHTML=`<div class="notice-bar notice-${kind}">${txt}</div>`;
};
const hideMsg=(target)=>{target.innerHTML='';};
const switchView=(view,saveLastView=true)=>{
if(saveLastView&&view!==Nodes.logViewer){
WidgetState.lastView=document.querySelector('.view-mode:not(.screen-off)');
}
Nodes.repoSelector.classList.add('screen-off');
Nodes.githubAuthView.classList.add('screen-off');
Nodes.githubBrowserView.classList.add('screen-off');
Nodes.cloneView.classList.add('screen-off');
Nodes.customPathView.classList.add('screen-off');
Nodes.timelineViewer.classList.add('screen-off');
Nodes.logViewer.classList.add('screen-off');
view.classList.remove('screen-off');
};
const setBusy=(btn,busy)=>{
if(busy){
btn.classList.add('btn-locked');
btn.dataset.orig=btn.innerHTML;
btn.innerHTML='<span class="spin-wheel"></span><span>Processing...</span>';
}else{
btn.classList.remove('btn-locked');
if(btn.dataset.orig)btn.innerHTML=btn.dataset.orig;
}
};
const callWrapper=async(wrapperName,args=[])=>{
console.log(`[GitUtil] Calling wrapper: ${wrapperName}`, args);
try{
if(typeof AndroidBridge !== 'undefined'){
const result=AndroidBridge.executeWrapper(wrapperName,JSON.stringify(args));
const parsed=JSON.parse(result);
console.log(`[GitUtil] Wrapper ${wrapperName} result:`, parsed);
return parsed;
}else{
const response=await fetch('http://localhost:8765/exec-wrapper',{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify({wrapper:wrapperName,args:args})
});
if(!response.ok){
const error=`Server error: ${response.status}`;
console.error(`[GitUtil] ${error}`);
throw new Error(error);
}
const result=await response.json();
console.log(`[GitUtil] Wrapper ${wrapperName} result:`, result);
return result;
}
}catch(err){
console.error(`[GitUtil] Wrapper ${wrapperName} execution failed:`, err);
return{success:false,output:`Connection failed: ${err.message}`};
}
};

const parseSnapshots=(raw)=>{
const blocks=raw.split('SNAPSHOT_BEGIN').filter(b=>b.trim());
return blocks.map(b=>{
const lines=b.split('\n');
const snap={};
lines.forEach(ln=>{
if(ln.startsWith('IDENTIFIER:'))snap.hash=ln.substring(11).trim();
if(ln.startsWith('CONTRIBUTOR:'))snap.who=ln.substring(12).trim();
if(ln.startsWith('WHEN:'))snap.when=new Date(parseInt(ln.substring(5).trim())*1000).toLocaleString();
if(ln.startsWith('TITLE:'))snap.title=ln.substring(6).trim();
});
if(snap.hash)snap.short=snap.hash.substring(0,8);
return snap;
}).filter(s=>s.hash&&s.title);
};

const parseRepos=(raw)=>{
const blocks=raw.split('REPO_SEPARATOR').filter(b=>b.trim()&&b.includes('REPO_NAME'));
return blocks.map(b=>{
const lines=b.split('\n');
const repo={};
lines.forEach(ln=>{
if(ln.startsWith('REPO_NAME:'))repo.name=ln.substring(10).trim();
if(ln.startsWith('REPO_PATH:'))repo.path=ln.substring(10).trim();
});
return repo;
}).filter(r=>r.name&&r.path);
};

const parseGitHubRepos=(raw)=>{
const blocks=raw.split('GITHUB_REPO_SEPARATOR').filter(b=>b.trim()&&b.includes('GITHUB_REPO_NAME'));
return blocks.map(b=>{
const lines=b.split('\n');
const repo={};
lines.forEach(ln=>{
if(ln.startsWith('GITHUB_REPO_NAME:'))repo.name=ln.substring('GITHUB_REPO_NAME:'.length).trim();
if(ln.startsWith('GITHUB_REPO_FULLNAME:'))repo.fullName=ln.substring('GITHUB_REPO_FULLNAME:'.length).trim();
if(ln.startsWith('GITHUB_REPO_URL:'))repo.url=ln.substring('GITHUB_REPO_URL:'.length).trim();
if(ln.startsWith('GITHUB_REPO_DESC:'))repo.description=ln.substring('GITHUB_REPO_DESC:'.length).trim();
if(ln.startsWith('GITHUB_REPO_PRIVATE:'))repo.isPrivate=ln.substring('GITHUB_REPO_PRIVATE:'.length).trim()==='true';
});
return repo;
}).filter(r=>r.name&&r.url);
};

const renderSnapshots=(snaps)=>{
Nodes.snapshotList.innerHTML='';
if(snaps.length===0){
Nodes.snapshotList.innerHTML='<div class="void-box"><div class="void-box__icon">üì≠</div><div>No snapshots found</div></div>';
return;
}
snaps.forEach(s=>{
const card=document.createElement('div');
card.className='snapshot-card';
card.dataset.hash=s.hash;
card.innerHTML=`
<div class="snapshot-card__hash">${s.short}</div>
<div class="snapshot-card__msg">${escapeHtml(s.title)}</div>
<div class="snapshot-card__meta">
<span class="meta-piece">üë§ ${escapeHtml(s.who)}</span>
<span class="meta-piece">‚è∞ ${s.when}</span>
</div>`;
card.onclick=()=>{
console.log('[UI] Commit selected for rollback:', s.short, '-', s.title);
WidgetState.picked=s.hash;
document.querySelectorAll('.snapshot-card').forEach(c=>c.classList.remove('active-pick'));
card.classList.add('active-pick');
Nodes.rollbackBtn.classList.remove('btn-locked');
console.log('[UI] Apply Rollback button is now enabled');
};
Nodes.snapshotList.appendChild(card);
});
};

const renderRepos=(repos)=>{
Nodes.repoList.innerHTML='';
if(repos.length===0){
Nodes.repoList.innerHTML='<div class="void-box"><div class="void-box__icon">üìÇ</div><div>No repositories yet<br><small>Clone a repository to get started</small></div></div>';
return;
}
repos.forEach(r=>{
const card=document.createElement('div');
card.className='repo-card';
card.innerHTML=`
<div class="repo-card__name">üìÅ ${escapeHtml(r.name)}</div>
<div class="repo-card__path">${escapeHtml(r.path)}</div>`;
card.onclick=()=>loadRepository(r.path);
Nodes.repoList.appendChild(card);
});
};

const renderGitHubRepos=(repos)=>{
Nodes.githubRepoList.innerHTML='';
if(repos.length===0){
Nodes.githubRepoList.innerHTML='<div class="void-box"><div class="void-box__icon">üåê</div><div>No repositories found</div></div>';
return;
}
repos.forEach(r=>{
const card=document.createElement('div');
card.className='repo-card';
const privacyIcon=r.isPrivate?'üîí':'üìÇ';
const desc=r.description?`<div class="repo-card__path">${escapeHtml(r.description)}</div>`:'';
card.innerHTML=`
<div class="repo-card__name">${privacyIcon} ${escapeHtml(r.fullName)}</div>
${desc}`;
card.onclick=()=>cloneGitHubRepo(r.url,r.name);
Nodes.githubRepoList.appendChild(card);
});
};

const loadRepository=async(path)=>{
console.log('[UI] Loading repository:', path);
showMsg(Nodes.repoMsg,'<span class="spin-wheel"></span> Loading repository...','info');
try{
const checkRes=await callWrapper('check-location',[path]);
if(!checkRes.success||!checkRes.output.includes('VALID')){
console.error('[UI] Repository validation failed:', path);
showMsg(Nodes.repoMsg,'Invalid repository','bad');
return;
}
console.log('[UI] Repository validated successfully');
WidgetState.loc=path;
const timelineRes=await callWrapper('pull-timeline',[path]);
if(timelineRes.success){
WidgetState.snapshots=parseSnapshots(timelineRes.output);
console.log('[UI] Loaded', WidgetState.snapshots.length, 'commits from repository');
Nodes.pathDisplay.textContent=`Repository: ${path.split('/').pop()}`;
renderSnapshots(WidgetState.snapshots);
switchView(Nodes.timelineViewer);
hideMsg(Nodes.rollbackMsg);
localStorage.setItem('gitutil_last_loc',path);
console.log('[UI] Timeline viewer is now active - please select a commit to enable rollback');
hideMsg(Nodes.repoMsg);
}else{
console.error('[UI] Failed to load timeline from repository');
showMsg(Nodes.repoMsg,'Failed to load commits','bad');
}
}catch(e){
showMsg(Nodes.repoMsg,`Error: ${e.message}`,'bad');
}
};

const refreshRepoList=async()=>{
showMsg(Nodes.repoMsg,'<span class="spin-wheel"></span> Loading repositories...','info');
const listRes=await callWrapper('list-repositories',[WidgetState.workspace]);
if(listRes.success){
WidgetState.repos=parseRepos(listRes.output);
renderRepos(WidgetState.repos);
hideMsg(Nodes.repoMsg);
}else{
showMsg(Nodes.repoMsg,'Failed to load repositories','bad');
}
};

const initWorkspace=async()=>{
showMsg(Nodes.repoMsg,'<span class="spin-wheel"></span> Initializing workspace...','info');
const wsRes=await callWrapper('ensure-workspace',[]);
if(wsRes.success){
const match=wsRes.output.match(/:(.*)/);
if(match){
WidgetState.workspace=match[1].trim();
Nodes.workspaceInfo.textContent=`Workspace: ${WidgetState.workspace}`;
await refreshRepoList();
}
}else{
showMsg(Nodes.repoMsg,'Failed to initialize workspace','bad');
}
};

// GitHub button
Nodes.githubBtn.onclick=()=>{
hideMsg(Nodes.githubAuthMsg);
const savedToken=localStorage.getItem('gitutil_github_token');
if(savedToken){
Nodes.githubTokenBox.value=savedToken;
}
switchView(Nodes.githubAuthView);
};

// GitHub auth button
Nodes.githubAuthBtn.onclick=async()=>{
const token=Nodes.githubTokenBox.value.trim();
if(!token){
showMsg(Nodes.githubAuthMsg,'Please enter your GitHub token','bad');
return;
}
hideMsg(Nodes.githubAuthMsg);
setBusy(Nodes.githubAuthBtn,true);
try{
const listRes=await callWrapper('list-github-repos',[token]);
if(listRes.success&&listRes.output.includes('GITHUB_REPOS_BEGIN')){
WidgetState.githubToken=token;
WidgetState.githubRepos=parseGitHubRepos(listRes.output);
localStorage.setItem('gitutil_github_token',token);
renderGitHubRepos(WidgetState.githubRepos);
switchView(Nodes.githubBrowserView);
hideMsg(Nodes.githubBrowserMsg);
}else{
showMsg(Nodes.githubAuthMsg,listRes.output||'Failed to connect to GitHub','bad');
}
}catch(e){
showMsg(Nodes.githubAuthMsg,`Error: ${e.message}`,'bad');
}finally{
setBusy(Nodes.githubAuthBtn,false);
}
};

// GitHub auth cancel
Nodes.githubAuthCancelBtn.onclick=()=>{
switchView(Nodes.repoSelector);
};

// GitHub back button
Nodes.githubBackBtn.onclick=()=>{
switchView(Nodes.repoSelector);
};

// Clone GitHub repository
const cloneGitHubRepo=async(url,name)=>{
hideMsg(Nodes.githubBrowserMsg);
showMsg(Nodes.githubBrowserMsg,`<span class="spin-wheel"></span> Cloning ${name}...`,'info');
try{
const cloneRes=await callWrapper('clone-repository',[url,name]);
if(cloneRes.success&&cloneRes.output.includes('CLONE_SUCCESS')){
const match=cloneRes.output.match(/:(.*)/);
if(match){
const repoPath=match[1].trim();
showMsg(Nodes.githubBrowserMsg,'‚úì Repository cloned successfully','good');
setTimeout(async()=>{
await refreshRepoList();
loadRepository(repoPath);
},1500);
}
}else{
showMsg(Nodes.githubBrowserMsg,cloneRes.output||'Clone failed','bad');
}
}catch(e){
showMsg(Nodes.githubBrowserMsg,`Error: ${e.message}`,'bad');
}
};

// Clone button
Nodes.cloneBtn.onclick=()=>{
hideMsg(Nodes.cloneMsg);
Nodes.cloneUrlBox.value='';
Nodes.cloneNameBox.value='';
switchView(Nodes.cloneView);
};

// Clone confirm
Nodes.cloneConfirmBtn.onclick=async()=>{
const url=Nodes.cloneUrlBox.value.trim();
const name=Nodes.cloneNameBox.value.trim();
if(!url){
showMsg(Nodes.cloneMsg,'Please enter a repository URL','bad');
return;
}
hideMsg(Nodes.cloneMsg);
setBusy(Nodes.cloneConfirmBtn,true);
try{
const cloneRes=await callWrapper('clone-repository',name?[url,name]:[url]);
if(cloneRes.success&&cloneRes.output.includes('CLONE_SUCCESS')){
const match=cloneRes.output.match(/:(.*)/);
if(match){
const repoPath=match[1].trim();
showMsg(Nodes.cloneMsg,'‚úì Repository cloned successfully','good');
setTimeout(async()=>{
await refreshRepoList();
loadRepository(repoPath);
},1500);
}
}else{
showMsg(Nodes.cloneMsg,cloneRes.output||'Clone failed','bad');
}
}catch(e){
showMsg(Nodes.cloneMsg,`Error: ${e.message}`,'bad');
}finally{
setBusy(Nodes.cloneConfirmBtn,false);
}
};

// Clone cancel
Nodes.cloneCancelBtn.onclick=()=>{
switchView(Nodes.repoSelector);
};

// Browse button
Nodes.browseBtn.onclick=()=>{
hideMsg(Nodes.locationMsg);
const saved=localStorage.getItem('gitutil_last_loc');
if(saved)Nodes.locationBox.value=saved;
switchView(Nodes.customPathView);
};

// Verify button
Nodes.verifyBtn.onclick=async()=>{
const loc=Nodes.locationBox.value.trim();
if(!loc){showMsg(Nodes.locationMsg,'Please enter a path','bad');return;}
hideMsg(Nodes.locationMsg);
setBusy(Nodes.verifyBtn,true);
try{
const res=await callWrapper('check-location',[loc]);
if(res.success&&res.output.includes('VALID')){
WidgetState.loc=loc;
const timelineRes=await callWrapper('pull-timeline',[loc]);
if(timelineRes.success){
WidgetState.snapshots=parseSnapshots(timelineRes.output);
Nodes.pathDisplay.textContent=`Location: ${loc}`;
renderSnapshots(WidgetState.snapshots);
switchView(Nodes.timelineViewer);
hideMsg(Nodes.rollbackMsg);
localStorage.setItem('gitutil_last_loc',loc);
}else{
showMsg(Nodes.locationMsg,'Failed to fetch timeline','bad');
}
}else{
showMsg(Nodes.locationMsg,'Invalid repository location','bad');
}
}catch(e){
showMsg(Nodes.locationMsg,`Error: ${e.message}`,'bad');
}finally{
setBusy(Nodes.verifyBtn,false);
}
};

// Custom cancel
Nodes.customCancelBtn.onclick=()=>{
switchView(Nodes.repoSelector);
};

// Rollback button
Nodes.rollbackBtn.onclick=async()=>{
console.log('[ROLLBACK] Apply Rollback button clicked');
if(!WidgetState.picked){
console.warn('[ROLLBACK] No commit selected - rollback cancelled');
showMsg(Nodes.rollbackMsg,'‚ö†Ô∏è Please select a commit first','alert');
return;
}
console.log('[ROLLBACK] Commit selected:', WidgetState.picked);
if(!confirm(`‚ö†Ô∏è WARNING\n\nRolling back to ${WidgetState.picked.substring(0,8)} will reset your branch.\nUncommitted changes will be lost.\n\nProceed?`)){
console.log('[ROLLBACK] User cancelled rollback at confirmation dialog');
return;
}
hideMsg(Nodes.rollbackMsg);
console.log('[ROLLBACK] ========================================');
console.log('[ROLLBACK] User confirmed rollback operation');
console.log('[ROLLBACK] Target commit:', WidgetState.picked);
console.log('[ROLLBACK] Repository:', WidgetState.loc);
console.log('[ROLLBACK] ========================================');
showMsg(Nodes.rollbackMsg,'‚è≥ Initiating rollback operation...','info');
setBusy(Nodes.rollbackBtn,true);
try{
console.log('[ROLLBACK] Calling wrapper: apply-rollback');
console.log('[ROLLBACK] Wrapper arguments:', [WidgetState.loc,WidgetState.picked]);
const res=await callWrapper('apply-rollback',[WidgetState.loc,WidgetState.picked]);
console.log('[ROLLBACK] Wrapper execution completed');
console.log('[ROLLBACK] Response object:', JSON.stringify(res,null,2));
console.log('[ROLLBACK] Response success flag:', res.success);
console.log('[ROLLBACK] Response exit code:', res.exit_code);
console.log('[ROLLBACK] Response output:', res.output);
console.log('[ROLLBACK] Response errors:', res.errors);
if(res.success&&res.output.startsWith('ROLLBACK_SUCCESS:')){
console.log('[ROLLBACK] ‚úì Rollback completed successfully');
console.log('[ROLLBACK] New HEAD is now at:', WidgetState.picked.substring(0,8));
showMsg(Nodes.rollbackMsg,`‚úì Successfully rolled back to ${WidgetState.picked.substring(0,8)}`,'good');
console.log('[ROLLBACK] Refreshing timeline in 1.5 seconds...');
setTimeout(async()=>{
console.log('[ROLLBACK] Fetching updated timeline...');
const refresh=await callWrapper('pull-timeline',[WidgetState.loc]);
if(refresh.success){
console.log('[ROLLBACK] Timeline refreshed successfully');
WidgetState.snapshots=parseSnapshots(refresh.output);
renderSnapshots(WidgetState.snapshots);
}else{
console.warn('[ROLLBACK] Timeline refresh failed:', refresh);
}
},1500);
}else{
console.error('[ROLLBACK] ‚ùå Rollback operation failed');
// Build detailed error message
let errorDetails='';
if(res.errors){
errorDetails+=res.errors;
console.error('[ROLLBACK] Error details from stderr:', res.errors);
}
if(res.output&&!res.output.startsWith('ROLLBACK_SUCCESS:')){
if(errorDetails)errorDetails+='\n';
errorDetails+=res.output;
console.error('[ROLLBACK] Output from stdout:', res.output);
}
if(!errorDetails){
errorDetails='Unknown error occurred. Check logs for details.';
console.error('[ROLLBACK] No error details available');
}
console.error('[ROLLBACK] Combined error message:', errorDetails);
const displayMsg=`‚ùå Rollback failed\n\n${errorDetails}\n\nTip: Use "View Logs" button to see detailed error information.`;
showMsg(Nodes.rollbackMsg,displayMsg.replace(/\n/g,'<br>'),'bad');
}
}catch(e){
console.error('[ROLLBACK] ‚ùå Exception occurred during rollback');
console.error('[ROLLBACK] Exception name:', e.name);
console.error('[ROLLBACK] Exception message:', e.message);
console.error('[ROLLBACK] Exception stack trace:', e.stack);
const displayMsg=`‚ùå Error during rollback\n\n${e.message}\n\nTip: Use "View Logs" button to see detailed error information.`;
showMsg(Nodes.rollbackMsg,displayMsg.replace(/\n/g,'<br>'),'bad');
}finally{
setBusy(Nodes.rollbackBtn,false);
console.log('[ROLLBACK] ========================================');
console.log('[ROLLBACK] Rollback operation completed');
console.log('[ROLLBACK] ========================================');
}
};

// Switch button
Nodes.switchBtn.onclick=()=>{
WidgetState.loc='';WidgetState.snapshots=[];WidgetState.picked=null;
switchView(Nodes.repoSelector);
refreshRepoList();
};

// View logs button
Nodes.viewLogsBtn.onclick=()=>{
switchView(Nodes.logViewer,true);
renderLogs();
};

// Refresh logs button
Nodes.refreshLogsBtn.onclick=()=>{
renderLogs();
};

// Clear logs button
Nodes.clearLogsBtn.onclick=()=>{
if(confirm('Clear all application logs?')){
AppLogs.length=0;
renderLogs();
}
};

// Close logs button
Nodes.closeLogsBtn.onclick=()=>{
if(WidgetState.lastView){
switchView(WidgetState.lastView,false);
}else{
switchView(Nodes.timelineViewer,false);
}
};

// Function to render logs
const renderLogs=()=>{
if(AppLogs.length===0){
Nodes.logContent.innerHTML='<div class="void-box"><div class="void-box__icon">üìã</div><div>No logs yet</div></div>';
return;
}
const logHtml=AppLogs.map(log=>{
const timeStr=new Date(log.time).toLocaleTimeString();
const cssClass=log.type==='error'?'log-error':log.type==='warn'?'log-warn':log.type==='info'?'log-info':'';
return `<div class="${cssClass}">${timeStr} ${escapeHtml(log.msg)}</div>`;
}).join('');
Nodes.logContent.innerHTML=logHtml;
Nodes.logContent.scrollTop=Nodes.logContent.scrollHeight;
};

// Enter key handlers
Nodes.locationBox.onkeypress=(e)=>{if(e.key==='Enter')Nodes.verifyBtn.click();};
Nodes.cloneUrlBox.onkeypress=(e)=>{if(e.key==='Enter')Nodes.cloneConfirmBtn.click();};

// Initialize on load
window.onload=async()=>{
console.log('[INIT] ========================================');
console.log('[INIT] GitUtil Mobile starting...');
console.log('[INIT] Version: 1.0');
console.log('[INIT] Timestamp:', new Date().toISOString());
console.log('[INIT] ========================================');
await initWorkspace();
// Auto-load last repository if it exists in workspace
const saved=localStorage.getItem('gitutil_last_loc');
if(saved){
console.log('[INIT] Found saved repository path:', saved);
// Check if the saved path exists in the workspace repos
const repoExists=WidgetState.repos.some(r=>r.path===saved);
if(repoExists){
console.log('[INIT] Auto-loading saved repository...');
loadRepository(saved);
}else{
console.log('[INIT] Saved repository not in workspace - showing repository selector');
}
// If not in workspace, we still show the repository selector
// User can use "Custom Path" to access it
}else{
console.log('[INIT] No saved repository - showing repository selector');
}
console.log('[INIT] Application initialized successfully');
console.log('[INIT] Tip: Use "üìã View Logs" button to see all application logs');
};
</script>
</body>
</html>
